"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[8317],{6872:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>p,frontMatter:()=>i,metadata:()=>o,toc:()=>l});var t=s(4848),a=s(8453);const i={},r="Async",o={id:"server/lua-api/async",title:"Async",description:"If you want to use IO while players are connected, you'll want to use the Async API to prevent server hiccups.",source:"@site/docs/02-server/05-lua-api/13-async.md",sourceDirName:"02-server/05-lua-api",slug:"/server/lua-api/async",permalink:"/server/lua-api/async",draft:!1,unlisted:!1,editUrl:"https://github.com/Hub-OS/documentation-website/tree/master/docs/02-server/05-lua-api/13-async.md",tags:[],version:"current",sidebarPosition:13,frontMatter:{},sidebar:"serverSidebar",previous:{title:"Synchronization",permalink:"/server/lua-api/synchronization"},next:{title:"Misc",permalink:"/server/lua-api/misc"}},c={},l=[{value:"Promises",id:"promises",level:2},{value:"<code>Async.create_promise&lt;T&gt;(function(resolve))</code>",id:"asynccreate_promisetfunctionresolve",level:3},{value:"<code>Async.await(promise)</code>",id:"asyncawaitpromise",level:3},{value:"<code>Async.await(async_iterator)</code>",id:"asyncawaitasync_iterator",level:3},{value:"<code>Async.await_all(promises)</code>",id:"asyncawait_allpromises",level:3},{value:"<code>Async.create_scope&lt;T&gt;(function(): T)</code>",id:"asynccreate_scopetfunction-t",level:3},{value:"<code>Async.create_function&lt;T&gt;(function(...): T|nil)</code>",id:"asynccreate_functiontfunction-tnil",level:3},{value:"<code>Async.request(url, request_options?)</code>",id:"asyncrequesturl-request_options",level:3},{value:"<code>Async.download(path, url, request_options?)</code>",id:"asyncdownloadpath-url-request_options",level:3},{value:"<code>Async.read_file(path)</code>",id:"asyncread_filepath",level:3},{value:"<code>Async.write_file(path, content)</code>",id:"asyncwrite_filepath-content",level:3},{value:"<code>Async.ensure_dir(path)</code>",id:"asyncensure_dirpath",level:3},{value:"<code>Async.poll_server(address)</code>",id:"asyncpoll_serveraddress",level:3},{value:"<code>Async.message_server(address, data)</code>",id:"asyncmessage_serveraddress-data",level:3},{value:"<code>Async.sleep(seconds)</code>",id:"asyncsleepseconds",level:3},{value:"<code>Async.message_player(player_id, message, mug_texture_path?, mug_animation_path?)</code>",id:"asyncmessage_playerplayer_id-message-mug_texture_path-mug_animation_path",level:3},{value:"<code>Async.message_player(player_id, message, textbox_options?)</code>",id:"asyncmessage_playerplayer_id-message-textbox_options",level:3},{value:"<code>Async.message_player_auto(player_id, message, close_delay, mug_texture_path?, mug_animation_path?)</code>",id:"asyncmessage_player_autoplayer_id-message-close_delay-mug_texture_path-mug_animation_path",level:3},{value:"<code>Async.message_player_auto(player_id, message, close_delay, textbox_options?)</code>",id:"asyncmessage_player_autoplayer_id-message-close_delay-textbox_options",level:3},{value:"<code>Async.question_player(player_id, question, mug_texture_path?, mug_animation_path?)</code>",id:"asyncquestion_playerplayer_id-question-mug_texture_path-mug_animation_path",level:3},{value:"<code>Async.question_player(player_id, question, textbox_options?)</code>",id:"asyncquestion_playerplayer_id-question-textbox_options",level:3},{value:"<code>Async.quiz_player(player_id, option_a?, option_b?, option_c?, mug_texture_path?, mug_animation_path?)</code>",id:"asyncquiz_playerplayer_id-option_a-option_b-option_c-mug_texture_path-mug_animation_path",level:3},{value:"<code>Async.quiz_player(player_id, option_a?, option_b?, option_c?, textbox_options?)</code>",id:"asyncquiz_playerplayer_id-option_a-option_b-option_c-textbox_options",level:3},{value:"<code>Async.prompt_player(player_id, character_limit?, default_text?)</code>",id:"asyncprompt_playerplayer_id-character_limit-default_text",level:3},{value:"<code>Async.initiate_encounter(player_id, package_path, encounter_data?)</code>",id:"asyncinitiate_encounterplayer_id-package_path-encounter_data",level:3},{value:"<code>Async.initiate_pvp(player_1_id, player_2_id, package_path?, encounter_data?)</code>",id:"asyncinitiate_pvpplayer_1_id-player_2_id-package_path-encounter_data",level:3},{value:"<code>Async.initiate_netplay(player_ids, package_path?, encounter_data?)</code>",id:"asyncinitiate_netplayplayer_ids-package_path-encounter_data",level:3},{value:"Net.BattleResults",id:"netbattleresults",level:2},{value:"Net.RequestOptions",id:"netrequestoptions",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"async",children:"Async"}),"\n",(0,t.jsx)(n.p,{children:"If you want to use IO while players are connected, you'll want to use the Async API to prevent server hiccups.\nNote: paths in this section use system paths and not asset paths."}),"\n",(0,t.jsx)(n.h2,{id:"promises",children:"Promises"}),"\n",(0,t.jsxs)(n.p,{children:["A promise is a table stand-in for an eventual value. It has an ",(0,t.jsx)(n.code,{children:"and_then"})," function, which accepts a callback that will eventually be called with the promised value or nil on failure. Most async functions will return a promise."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:"promise.and_then(function(value)\n  print(value)\nend)\n"})}),"\n",(0,t.jsx)(n.h3,{id:"asynccreate_promisetfunctionresolve",children:(0,t.jsx)(n.code,{children:"Async.create_promise<T>(function(resolve))"})}),"\n",(0,t.jsxs)(n.p,{children:["Returns a promise from a callback. A resolve function is passed to this callback, which calls functions passed to ",(0,t.jsx)(n.code,{children:"and_then"})]}),"\n",(0,t.jsxs)(n.p,{children:["This promise supports late calls to ",(0,t.jsx)(n.code,{children:"and_then"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:'local promise = Async.create_promise(function(resolve)\n  resolve(1, 2, 3)\nend)\n\npromise.and_then(print) -- outputs "1 2 3"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"asyncawaitpromise",children:(0,t.jsx)(n.code,{children:"Async.await(promise)"})}),"\n",(0,t.jsx)(n.p,{children:"Can only be used within an async scope or coroutine."}),"\n",(0,t.jsx)(n.p,{children:"Waits for a promise by providing a function to and_then and yielding until the function is called."}),"\n",(0,t.jsx)(n.p,{children:"Returns the value passed by and_then"}),"\n",(0,t.jsx)(n.h3,{id:"asyncawaitasync_iterator",children:(0,t.jsx)(n.code,{children:"Async.await(async_iterator)"})}),"\n",(0,t.jsx)(n.p,{children:"Returns an iterator from an async iterator (an iterator which returns promises)."}),"\n",(0,t.jsxs)(n.p,{children:["Can only be used within a coroutine. Use ",(0,t.jsx)(n.code,{children:"Async.promisify()"})," to let the server handle resuming the coroutine."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:'-- example with Async.await(async_iterator)\nlocal shop_items = {\n  { name = "a", price = 0 },\n  { name = "b", price = 0 }\n}\n\nNet:on("player_join", Async.create_function(function(event)\n  local emitter = Net.open_shop(event.player_id, )\n\n  -- events are automatically awaited\n  for event in Async.await(emitter:async_iter("shop_purchase")) do\n    print(event)\n  end\nend))\n'})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:'-- example without Async.await(async_iterator)\nlocal shop_items = {\n  { name = "a", price = 0 },\n  { name = "b", price = 0 }\n}\n\nNet:on("player_join", Async.create_function(function(event)\n  local emitter = Net.open_shop(event.player_id)\n\n  for promise in emitter:async_iter("shop_purchase") do\n    -- each event must be awaited individually\n    local event = Async.await(promise)\n    print(event)\n  end\nend))\n'})}),"\n",(0,t.jsx)(n.h3,{id:"asyncawait_allpromises",children:(0,t.jsx)(n.code,{children:"Async.await_all(promises)"})}),"\n",(0,t.jsx)(n.p,{children:"Can only be used within an async scope or coroutine."}),"\n",(0,t.jsx)(n.p,{children:"Takes a list of promises and returns a list of values."}),"\n",(0,t.jsx)(n.h3,{id:"asynccreate_scopetfunction-t",children:(0,t.jsx)(n.code,{children:"Async.create_scope<T>(function(): T)"})}),"\n",(0,t.jsx)(n.p,{children:"Returns a promise, resolves to the return value."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:'local promise = Async.create_scope(function()\n  Async.await(Async.sleep(5))\n\n  return "hi"\nend)\n\npromise.and_then(print) -- says "hi" after 5s\n'})}),"\n",(0,t.jsx)(n.h3,{id:"asynccreate_functiontfunction-tnil",children:(0,t.jsx)(n.code,{children:"Async.create_function<T>(function(...): T|nil)"})}),"\n",(0,t.jsx)(n.p,{children:"Returns a function that returns a promise, which resolves to the return value."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:'local say_after = Async.create_function(function(message, delay)\n  Async.await(Async.sleep(delay)))\n\n  return message\nend)\n\nsay_after("hello", 5).and_then(print) -- says "hello" after 5s\nsay_after("world", 10).and_then(print) -- says "world" after 10s\n'})}),"\n",(0,t.jsx)(n.h3,{id:"asyncrequesturl-request_options",children:(0,t.jsx)(n.code,{children:"Async.request(url, request_options?)"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"request_options"}),": ",(0,t.jsx)(n.a,{href:"#netrequestoptions",children:"Net.RequestOptions"})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Returns a promise that resolves to ",(0,t.jsx)(n.code,{children:"{ status, headers, body }?"})]}),"\n",(0,t.jsx)(n.h3,{id:"asyncdownloadpath-url-request_options",children:(0,t.jsx)(n.code,{children:"Async.download(path, url, request_options?)"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"request_options"}),": ",(0,t.jsx)(n.a,{href:"#netrequestoptions",children:"Net.RequestOptions"})]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Downloads a file straight to disk."}),"\n",(0,t.jsxs)(n.p,{children:["Returns a promise that resolves to ",(0,t.jsx)(n.code,{children:"true"})," if the file was successfully saved, or ",(0,t.jsx)(n.code,{children:"false"})," if the operation failed."]}),"\n",(0,t.jsx)(n.h3,{id:"asyncread_filepath",children:(0,t.jsx)(n.code,{children:"Async.read_file(path)"})}),"\n",(0,t.jsx)(n.p,{children:"Returns a promise that resolves to a string representing the bytes stored in the file."}),"\n",(0,t.jsx)(n.p,{children:"An empty string is returned if reading failed."}),"\n",(0,t.jsx)(n.h3,{id:"asyncwrite_filepath-content",children:(0,t.jsx)(n.code,{children:"Async.write_file(path, content)"})}),"\n",(0,t.jsxs)(n.p,{children:["Returns a promise that resolves to ",(0,t.jsx)(n.code,{children:"true"})," if the file was successfully saved, or ",(0,t.jsx)(n.code,{children:"false"})," if the operation failed."]}),"\n",(0,t.jsx)(n.h3,{id:"asyncensure_dirpath",children:(0,t.jsx)(n.code,{children:"Async.ensure_dir(path)"})}),"\n",(0,t.jsxs)(n.p,{children:["Creates a directory at ",(0,t.jsx)(n.code,{children:"path"})," if it does not already exist."]}),"\n",(0,t.jsx)(n.p,{children:"Returns a promise."}),"\n",(0,t.jsx)(n.h3,{id:"asyncpoll_serveraddress",children:(0,t.jsx)(n.code,{children:"Async.poll_server(address)"})}),"\n",(0,t.jsxs)(n.p,{children:["Returns a promise that resolves to ",(0,t.jsx)(n.code,{children:"{}?"})]}),"\n",(0,t.jsx)(n.h3,{id:"asyncmessage_serveraddress-data",children:(0,t.jsx)(n.code,{children:"Async.message_server(address, data)"})}),"\n",(0,t.jsxs)(n.p,{children:["You will not know if this succeeds, the other server will need to reply. See ",(0,t.jsx)(n.a,{href:"/server/lua-api/events#server_message",children:"server_message"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"asyncsleepseconds",children:(0,t.jsx)(n.code,{children:"Async.sleep(seconds)"})}),"\n",(0,t.jsx)(n.p,{children:"Returns a promise that resolves after the duration has passed."}),"\n",(0,t.jsx)(n.h3,{id:"asyncmessage_playerplayer_id-message-mug_texture_path-mug_animation_path",children:(0,t.jsx)(n.code,{children:"Async.message_player(player_id, message, mug_texture_path?, mug_animation_path?)"})}),"\n",(0,t.jsxs)(n.p,{children:["Returns a promise that resolves to ",(0,t.jsx)(n.code,{children:"0"})," or ",(0,t.jsx)(n.code,{children:"nil"})," for disconnected."]}),"\n",(0,t.jsx)(n.h3,{id:"asyncmessage_playerplayer_id-message-textbox_options",children:(0,t.jsx)(n.code,{children:"Async.message_player(player_id, message, textbox_options?)"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"textbox_options"}),": ",(0,t.jsx)(n.a,{href:"/server/lua-api/widgets#nettextboxoptions",children:"Net.TextboxOptions"})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Returns a promise that resolves to ",(0,t.jsx)(n.code,{children:"0"})," or ",(0,t.jsx)(n.code,{children:"nil"})," for disconnected."]}),"\n",(0,t.jsx)(n.h3,{id:"asyncmessage_player_autoplayer_id-message-close_delay-mug_texture_path-mug_animation_path",children:(0,t.jsx)(n.code,{children:"Async.message_player_auto(player_id, message, close_delay, mug_texture_path?, mug_animation_path?)"})}),"\n",(0,t.jsxs)(n.p,{children:["Returns a promise that resolves to ",(0,t.jsx)(n.code,{children:"0"})," or ",(0,t.jsx)(n.code,{children:"nil"})," for disconnected."]}),"\n",(0,t.jsx)(n.h3,{id:"asyncmessage_player_autoplayer_id-message-close_delay-textbox_options",children:(0,t.jsx)(n.code,{children:"Async.message_player_auto(player_id, message, close_delay, textbox_options?)"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"textbox_options"}),": ",(0,t.jsx)(n.a,{href:"/server/lua-api/widgets#nettextboxoptions",children:"Net.TextboxOptions"})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Returns a promise that resolves to ",(0,t.jsx)(n.code,{children:"0"})," or ",(0,t.jsx)(n.code,{children:"nil"})," for disconnected."]}),"\n",(0,t.jsx)(n.h3,{id:"asyncquestion_playerplayer_id-question-mug_texture_path-mug_animation_path",children:(0,t.jsx)(n.code,{children:"Async.question_player(player_id, question, mug_texture_path?, mug_animation_path?)"})}),"\n",(0,t.jsxs)(n.p,{children:["Returns a promise that resolves to ",(0,t.jsx)(n.code,{children:"1"})," for yes, ",(0,t.jsx)(n.code,{children:"0"})," for no, and ",(0,t.jsx)(n.code,{children:"nil"})," for disconnected."]}),"\n",(0,t.jsx)(n.h3,{id:"asyncquestion_playerplayer_id-question-textbox_options",children:(0,t.jsx)(n.code,{children:"Async.question_player(player_id, question, textbox_options?)"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"textbox_options"}),": ",(0,t.jsx)(n.a,{href:"/server/lua-api/widgets#nettextboxoptions",children:"Net.TextboxOptions"})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Returns a promise that resolves to ",(0,t.jsx)(n.code,{children:"1"})," for yes, ",(0,t.jsx)(n.code,{children:"0"})," for no, and ",(0,t.jsx)(n.code,{children:"nil"})," for disconnected."]}),"\n",(0,t.jsx)(n.h3,{id:"asyncquiz_playerplayer_id-option_a-option_b-option_c-mug_texture_path-mug_animation_path",children:(0,t.jsx)(n.code,{children:"Async.quiz_player(player_id, option_a?, option_b?, option_c?, mug_texture_path?, mug_animation_path?)"})}),"\n",(0,t.jsxs)(n.p,{children:["Returns a promise that resolves to 0-2 for option a-c, or ",(0,t.jsx)(n.code,{children:"nil"})," for disconnected."]}),"\n",(0,t.jsx)(n.h3,{id:"asyncquiz_playerplayer_id-option_a-option_b-option_c-textbox_options",children:(0,t.jsx)(n.code,{children:"Async.quiz_player(player_id, option_a?, option_b?, option_c?, textbox_options?)"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"textbox_options"}),": ",(0,t.jsx)(n.a,{href:"/server/lua-api/widgets#nettextboxoptions",children:"Net.TextboxOptions"})]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Returns a promise that resolves to 0-2 for option a-c, or ",(0,t.jsx)(n.code,{children:"nil"})," for disconnected."]}),"\n",(0,t.jsx)(n.h3,{id:"asyncprompt_playerplayer_id-character_limit-default_text",children:(0,t.jsx)(n.code,{children:"Async.prompt_player(player_id, character_limit?, default_text?)"})}),"\n",(0,t.jsxs)(n.p,{children:["Returns a promise that resolves to ",(0,t.jsx)(n.code,{children:"string"}),", or ",(0,t.jsx)(n.code,{children:"nil"})," for disconnected."]}),"\n",(0,t.jsx)(n.h3,{id:"asyncinitiate_encounterplayer_id-package_path-encounter_data",children:(0,t.jsx)(n.code,{children:"Async.initiate_encounter(player_id, package_path, encounter_data?)"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"encounter_data"}),": anything that could be represented as JSON.","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Read as second param in encounter_init for the encounter package"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Returns ",(0,t.jsx)(n.code,{children:"Net.Promise<Net.BattleResults?>"})]}),"\n",(0,t.jsx)(n.h3,{id:"asyncinitiate_pvpplayer_1_id-player_2_id-package_path-encounter_data",children:(0,t.jsx)(n.code,{children:"Async.initiate_pvp(player_1_id, player_2_id, package_path?, encounter_data?)"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"encounter_data"}),": anything that could be represented as JSON.","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Read as second param in encounter_init for the encounter package"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Returns ",(0,t.jsx)(n.code,{children:"Net.Promise<Net.BattleResults?>[]"})]}),"\n",(0,t.jsx)(n.h3,{id:"asyncinitiate_netplayplayer_ids-package_path-encounter_data",children:(0,t.jsx)(n.code,{children:"Async.initiate_netplay(player_ids, package_path?, encounter_data?)"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"encounter_data"}),": anything that could be represented as JSON.","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Read as second param in encounter_init for the encounter package"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Returns ",(0,t.jsx)(n.code,{children:"Net.Promise<Net.BattleResults?>[]"})]}),"\n",(0,t.jsx)(n.h2,{id:"netbattleresults",children:"Net.BattleResults"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:"---@class Net.BattleResults\n---@field player_id Net.ActorId\n---@field won boolean\n---@field health number\n---@field score number\n---@field time number\n---@field ran boolean\n---@field emotion string\n---@field turns number\n---@field allies { name: string, health: number }[]\n---@field enemies { name: string, health: number }[]\n---@field neutral { name: string, health: number }[]\n"})}),"\n",(0,t.jsx)(n.h2,{id:"netrequestoptions",children:"Net.RequestOptions"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-lua",children:"---@class Net.RequestOptions\n---@field method? string\n---@field headers? table<string, string>\n---@field body? string\n"})})]})}function p(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>o});var t=s(6540);const a={},i=t.createContext(a);function r(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);